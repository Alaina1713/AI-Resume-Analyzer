<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Analysis Result</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <a href="{{ url_for('index') }}" class="btn btn-link mb-3">&larr; Back</a>

      <div class="row g-4">
        <!-- LEFT -->
        <div class="col-md-6">
          <div class="card p-3 shadow-sm">
            <h4>Overall ATS Score</h4>
            <h1 class="display-4">{{ overall|default(0) }}%</h1>
            <p class="text-muted">Composite of similarity, skills match, keyword match, formatting and readability.</p>
            <canvas id="radarChart" height="250"></canvas>
          </div>

          <div class="card p-3 mt-3 shadow-sm">
            <h5>Key Metrics</h5>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">Similarity with JD: <strong>{{ sim_score|default(0) }}%</strong></li>
              <li class="list-group-item">Skills match: <strong>{{ skills_pct|default(0) }}%</strong></li>
              <li class="list-group-item">Keyword match: <strong>{{ keyword_pct|default(0) }}%</strong></li>
              <li class="list-group-item">Formatting score: <strong>{{ fmt_score|default(0) }}%</strong></li>
              <li class="list-group-item">Readability (Flesch): <strong>{{ read_score|default(0) }}</strong></li>
            </ul>
          </div>

          <div class="card p-3 mt-3 shadow-sm">
            <h5>Found Skills</h5>
            {% if found_skills %}
              {% for s in found_skills %}
                <span class="badge bg-success me-1">{{ s }}</span>
              {% endfor %}
            {% else %}
              <p class="text-muted">No common skills found from the dictionary.</p>
            {% endif %}
          </div>
        </div>

        <!-- RIGHT -->
        <div class="col-md-6">
          <div class="card p-3 shadow-sm">
            <h5>Top Keywords in Job Description</h5>
            <p class="small text-muted">Top JD keywords (matched keywords are highlighted)</p>
            <div>
              {% if top_kw %}
                {% for k in top_kw %}
                  {% if matched_kw and (k in matched_kw) %}
                    <span class="badge bg-primary me-1 mb-1">{{ k }}</span>
                  {% else %}
                    <span class="badge bg-secondary me-1 mb-1">{{ k }}</span>
                  {% endif %}
                {% endfor %}
              {% else %}
                <div class="text-muted small">No keywords extracted from job description.</div>
              {% endif %}
            </div>
          </div>

          <div class="card p-3 mt-3 shadow-sm">
            <h5>Resume Preview & Top Resume Keywords</h5>
            <div class="small text-muted mb-2">Top resume keywords:</div>
            <div class="mb-2">
              {% if top_res_keywords %}
                {% for k in top_res_keywords %}
                  <span class="badge bg-info text-dark me-1 mb-1">{{ k }}</span>
                {% endfor %}
              {% else %}
                <div class="text-muted small">No keywords found in resume.</div>
              {% endif %}
            </div>
            <pre class="preview">{{ preview|default('No preview available') }}</pre>
          </div>

          <div class="card p-3 mt-3 shadow-sm">
            <h5>Formatting Checks</h5>
            <ul>
              <li>Has Education section:
                {% if fmt_checks and fmt_checks.get('has_education') %}
                  <strong>Yes</strong>
                {% else %}
                  <strong>No</strong>
                {% endif %}
              </li>
              <li>Has Experience section:
                {% if fmt_checks and (fmt_checks.get('has_experience') or fmt_checks.get('has_work')) %}
                  <strong>Yes</strong>
                {% else %}
                  <strong>No</strong>
                {% endif %}
              </li>
              <li>Has Contact (email/phone):
                {% if fmt_checks and fmt_checks.get('has_contact') %}
                  <strong>Yes</strong>
                {% else %}
                  <strong>No</strong>
                {% endif %}
              </li>
              <li>Has Skills section:
                {% if fmt_checks and fmt_checks.get('has_skills_section') %}
                  <strong>Yes</strong>
                {% else %}
                  <strong>No</strong>
                {% endif %}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Safely parse numbers (NaN fallback = 0)
      const sim = Number("{{ sim_score|default(0) }}") || 0;
      const skills = Number("{{ skills_pct|default(0) }}") || 0;
      const keywords = Number("{{ keyword_pct|default(0) }}") || 0;
      const formatting = Number("{{ fmt_score|default(0) }}") || 0;
      const readability = Number("{{ read_score|default(0) }}") || 0;

      const data = {
        labels: ['Similarity', 'Skills', 'Keywords', 'Formatting', 'Readability'],
        datasets: [{
          label: 'Components (%)',
          data: [sim, skills, keywords, formatting, readability],
          fill: true,
          backgroundColor: 'rgba(54, 162, 235, 0.15)',
          borderColor: 'rgb(54, 162, 235)',
          pointBackgroundColor: 'rgb(54, 162, 235)'
        }]
      };

      const ctx = document.getElementById('radarChart');
      if (ctx) {
        new Chart(ctx, {
          type: 'radar',
          data: data,
          options: { scales: { r: { suggestedMin: 0, suggestedMax: 100 } } }
        });
      }
    </script>
  </body>
</html>
